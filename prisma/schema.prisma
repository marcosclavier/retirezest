generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                         String                    @id @default(uuid())
  email                      String                    @unique
  passwordHash               String
  firstName                  String?
  lastName                   String?
  dateOfBirth                DateTime?
  province                   String?
  maritalStatus              String?
  createdAt                  DateTime                  @default(now())
  updatedAt                  DateTime                  @updatedAt
  includePartner             Boolean                   @default(false)
  partnerDateOfBirth         DateTime?
  partnerFirstName           String?
  partnerLastName            String?
  resetToken                 String?                   @unique
  resetTokenExpiry           DateTime?
  cppCalculatorUsedAt        DateTime?
  lifeExpectancy             Int?                      @default(95)
  oasCalculatorUsedAt        DateTime?
  targetRetirementAge        Int?
  completedGuideAt           DateTime?
  hasSeenWelcome             Boolean                   @default(false)
  onboardingCompleted        Boolean                   @default(false)
  onboardingStep             Int?
  userPath                   String?
  companyLogo                String?
  companyName                String?
  emailVerificationExpiry    DateTime?
  emailVerificationToken     String?                   @unique
  emailVerified              Boolean                   @default(false)
  verificationEmailSentAt    DateTime?
  deletedAt                  DateTime?
  deletionReason             String?
  scheduledDeletionAt        DateTime?
  simulationReadyEmailSentAt DateTime?
  earlyRetirementCalcsDate   DateTime?
  earlyRetirementCalcsToday  Int                       @default(0)
  stripeCustomerId           String?                   @unique
  stripePriceId              String?
  stripeSubscriptionId       String?                   @unique
  subscriptionEndDate        DateTime?
  subscriptionStartDate      DateTime?
  subscriptionStatus         String                    @default("active")
  subscriptionTier           String                    @default("free")
  role                       String                    @default("user")
  freeSimulationsUsed        Int                       @default(0)
  simulationRunsToday        Int                       @default(0)
  simulationRunsDate         DateTime?
  marketingEmailsEnabled     Boolean                   @default(true)
  feedbackEmailsEnabled      Boolean                   @default(true)
  unsubscribedAt             DateTime?
  unsubscribeToken           String?                   @unique
  assets                     Asset[]
  debts                      Debt[]
  expenses                   Expense[]
  incomeSources              Income[]
  projections                Projection[]
  scenarios                  Scenario[]
  simulationRuns             SimulationRun[]
  auditLogs                  AuditLog[]
  realEstateAssets           RealEstateAsset[]
  savedSimulationScenarios   SavedSimulationScenario[]
  userFeedback               UserFeedback[]
  quebecBenefits             QuebecBenefits?

  @@index([email])
  @@index([createdAt])
  @@index([resetToken])
  @@index([emailVerificationToken])
  @@index([unsubscribeToken])
  @@index([deletedAt])
  @@index([scheduledDeletionAt])
  @@index([role])
  @@index([subscriptionTier])
  @@index([subscriptionStatus])
  @@index([stripeCustomerId])
  @@index([stripeSubscriptionId])
}

model Income {
  id               String   @id @default(uuid())
  userId           String
  type             String
  description      String?
  amount           Float
  frequency        String
  isTaxable        Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  notes            String?
  startAge         Int?
  owner            String?  @default("person1")
  inflationIndexed Boolean  @default(true)
  endAge           Int?
  // New month/year date fields
  startMonth       Int?     // 1-12 for month
  startYear        Int?     // Year when income starts
  endMonth         Int?     // 1-12 for month
  endYear          Int?     // Year when income ends
  // Quebec-specific fields for QPP
  qppContributions      Float?
  qppYearsContributed   Int?
  qppPensionableEarnings Float?
  qppEstimatedBenefit   Float?
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([userId, owner])
  @@index([createdAt])
}

model QuebecBenefits {
  id                     String   @id @default(uuid())
  userId                 String   @unique
  solidarityCredit       Float?
  workPremium            Float?
  seniorAssistance       Float?
  homeSupportCredit      Float?
  qppRetirementSupplement Float?
  drugInsurancePremium   Float?
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  user                   User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Asset {
  id                        String    @id @default(uuid())
  userId                    String
  type                      String
  description               String?
  currentValue              Float?
  contributionRoom          Float?
  createdAt                 DateTime  @default(now())
  updatedAt                 DateTime  @updatedAt
  balance                   Float
  name                      String
  notes                     String?
  returnRate                Float?
  owner                     String?   @default("person1")
  earlyRrifAnnualAmount     Float?
  earlyRrifEndAge           Int?
  earlyRrifMode             String?
  earlyRrifPercentage       Float?
  earlyRrifStartAge         Int?
  enableEarlyRrifWithdrawal Boolean?  @default(false)
  gicCompoundingFrequency   String?
  gicInterestRate           Float?
  gicIssuer                 String?
  gicMaturityDate           DateTime?
  gicReinvestStrategy       String?
  gicTermMonths             Int?
  user                      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([userId, owner])
  @@index([createdAt])
}

model Expense {
  id          String   @id @default(uuid())
  userId      String
  category    String
  description String?
  amount      Float
  frequency   String
  isEssential Boolean?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  essential   Boolean  @default(true)
  notes       String?
  isRecurring Boolean  @default(true)
  plannedYear Int?
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, category])
  @@index([userId, essential])
  @@index([userId, isRecurring])
  @@index([userId, plannedYear])
  @@index([createdAt])
}

model Debt {
  id               String   @id @default(uuid())
  userId           String
  type             String
  description      String?
  currentBalance   Float?
  interestRate     Float
  monthlyPayment   Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  balance          Float
  creditor         String
  minimumPayment   Float
  notes            String?
  paymentFrequency String   @default("monthly")
  user             User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, type])
  @@index([createdAt])
}

model Scenario {
  id                      String       @id @default(uuid())
  userId                  String
  name                    String
  description             String?
  currentAge              Int
  retirementAge           Int
  lifeExpectancy          Int          @default(95)
  province                String       @default("ON")
  rrspBalance             Float        @default(0)
  tfsaBalance             Float        @default(0)
  nonRegBalance           Float        @default(0)
  realEstateValue         Float        @default(0)
  employmentIncome        Float        @default(0)
  pensionIncome           Float        @default(0)
  rentalIncome            Float        @default(0)
  otherIncome             Float        @default(0)
  cppStartAge             Int          @default(65)
  oasStartAge             Int          @default(65)
  averageCareerIncome     Float        @default(0)
  yearsOfCPPContributions Int          @default(40)
  yearsInCanada           Int          @default(40)
  annualExpenses          Float
  expenseInflationRate    Float        @default(2.0)
  investmentReturnRate    Float        @default(5.0)
  inflationRate           Float        @default(2.0)
  rrspToRrifAge           Int          @default(71)
  projectionResults       String?
  isBaseline              Boolean      @default(false)
  createdAt               DateTime     @default(now())
  updatedAt               DateTime     @updatedAt
  withdrawalStrategy      String       @default("RRIF->Corp->NonReg->TFSA")
  liraBalance             Float        @default(0)
  projections             Projection[]
  user                    User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, isBaseline])
  @@index([createdAt])
}

model Projection {
  id                  String   @id @default(uuid())
  userId              String
  scenarioId          String
  retirementAge       Int
  calculationDate     DateTime @default(now())
  results             String
  successProbability  Float?
  totalLifetimeIncome Float?
  estateValue         Float?
  createdAt           DateTime @default(now())
  scenario            Scenario @relation(fields: [scenarioId], references: [id], onDelete: Cascade)
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([scenarioId])
  @@index([userId, scenarioId])
  @@index([createdAt])
  @@index([calculationDate])
}

model SimulationRun {
  id                   String   @id @default(uuid())
  userId               String
  strategy             String
  province             String
  startAge             Int
  endAge               Int
  includePartner       Boolean  @default(false)
  partnerStartAge      Int?
  spendingGoGo         Float?
  spendingSlowGo       Float?
  spendingNoGo         Float?
  healthScore          Float?
  healthRating         String?
  successRate          Float?
  yearsFunded          Int?
  yearsSimulated       Int?
  totalTaxPaid         Float?
  avgTaxRate           Float?
  finalEstate          Float?
  finalEstateGross     Float?
  totalCPP             Float?
  totalOAS             Float?
  totalGIS             Float?
  totalBenefits        Float?
  totalRRIFWithdrawn   Float?
  totalNonRegWithdrawn Float?
  totalTFSAWithdrawn   Float?
  totalCorpWithdrawn   Float?
  initialTFSA          Float?
  initialRRSP          Float?
  initialRRIF          Float?
  initialNonReg        Float?
  initialCorp          Float?
  initialNetWorth      Float?
  inputData            String?
  fullResults          String?
  createdAt            DateTime @default(now())
  isQuickStart         Boolean  @default(false)
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([strategy])
  @@index([healthScore])
}

model AuditLog {
  id           String   @id @default(uuid())
  userId       String
  action       String
  description  String?
  metadata     String?
  ipAddress    String?
  userAgent    String?
  success      Boolean  @default(true)
  errorMessage String?
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([action])
  @@index([createdAt])
  @@map("audit_logs")
}

model UserFeedback {
  id                    String    @id @default(uuid())
  userId                String?
  feedbackType          String
  triggerContext        String?
  satisfactionScore     Int?
  npsScore              Int?
  helpfulnessScore      Int?
  didSimulationHelp     String?
  missingFeatures       String?
  improvementAreas      String?
  whatWouldMakeUseful   String?
  whatIsConfusing       String?
  improvementSuggestion String?
  additionalComments    String?
  pageUrl               String?
  referrerUrl           String?
  userAgent             String?
  sessionId             String?
  userAge               Int?
  userProvince          String?
  includesPartner       Boolean?
  subscriptionTier      String?
  simulationCount       Int?
  daysSinceSignup       Int?
  responded             Boolean   @default(false)
  respondedAt           DateTime?
  respondedBy           String?
  responseNotes         String?
  priority              Int       @default(3)
  status                String    @default("new")
  tags                  String?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
  user                  User?     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([feedbackType])
  @@index([status])
  @@index([priority])
  @@index([createdAt])
  @@index([satisfactionScore])
  @@index([npsScore])
  @@map("user_feedback")
}

model SavedSimulationScenario {
  id           String   @id @default(uuid())
  userId       String
  name         String
  description  String?
  scenarioType String   @default("custom")
  inputData    String
  results      String?
  hasResults   Boolean  @default(false)
  isFavorite   Boolean  @default(false)
  tags         String?
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, createdAt])
  @@index([userId, scenarioType])
  @@index([userId, isFavorite])
  @@index([createdAt])
  @@map("saved_simulation_scenarios")
}

model RealEstateAsset {
  id                      String   @id @default(uuid())
  userId                  String
  propertyType            String
  address                 String?
  city                    String?
  province                String?
  purchasePrice           Float
  purchaseDate            DateTime
  currentValue            Float
  mortgageBalance         Float    @default(0)
  monthlyRentalIncome     Float    @default(0)
  monthlyExpenses         Float    @default(0)
  owner                   String   @default("person1")
  ownershipPercent        Float    @default(100)
  isPrincipalResidence    Boolean  @default(false)
  principalResidenceYears Float    @default(0)
  planToSell              Boolean  @default(false)
  plannedSaleYear         Int?
  plannedSalePrice        Float?
  downsizeTo              Float?
  notes                   String?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt
  user                    User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([propertyType])
  @@index([isPrincipalResidence])
  @@map("real_estate_assets")
}
